<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiptune Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #1a1a1a;
            color: #e8e8e8;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .top-panel {
            background: #242424;
            border-bottom: 1px solid #2a2a2a;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .top-panel h1 {
            font-size: 16px;
            font-weight: 500;
            flex: 1 1 auto;
            min-width: 120px;
        }
        
        .top-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        button {
            background: #2a2a2a;
            color: #e8e8e8;
            border: 1px solid #3a3a3a;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s;
            min-height: 44px;
            touch-action: manipulation;
        }
        
        button:hover {
            background: #333;
        }
        
        button:active {
            background: #3a3a3a;
        }
        
        input[type="text"], input[type="number"] {
            background: #1a1a1a;
            color: #e8e8e8;
            border: 1px solid #3a3a3a;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            min-height: 44px;
        }
        
        .tracker-container {
            flex: 1;
            overflow: auto;
            padding: 12px;
            -webkit-overflow-scrolling: touch;
        }
        
        .tracker-grid {
            display: grid;
            grid-template-columns: 40px repeat(6, minmax(70px, 1fr));
            gap: 3px;
            font-size: 11px;
            max-width: 1200px;
            margin: 0 auto;
            min-width: min-content;
        }
        
        @media (max-width: 768px) {
            .tracker-grid {
                grid-template-columns: 30px repeat(6, minmax(50px, 1fr));
                font-size: 9px;
                gap: 2px;
            }
        }
        
        .header-cell {
            background: #242424;
            padding: 12px;
            text-align: center;
            border-radius: 4px;
            border: 1px solid #2a2a2a;
            color: #999;
        }
        
        .step-number {
            background: #242424;
            padding: 12px 6px;
            text-align: center;
            border-radius: 4px;
            border: 1px solid #2a2a2a;
            color: #666;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .step-number.measure-start {
            border-bottom: 3px solid #666;
            font-weight: 600;
        }
        
        .note-cell {
            background: #242424;
            padding: 12px 6px;
            text-align: center;
            cursor: pointer;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            min-height: 44px;
            min-width: 60px;
            color: #666;
            font-size: 10px;
            line-height: 1.3;
            user-select: none;
            -webkit-user-select: none;
            transition: all 0.1s;
        }
        
        .note-cell:hover {
            background: #2a2a2a;
        }
        
        .note-cell.active {
            font-weight: 500;
        }
        
        .note-cell.playing {
            filter: brightness(1.8) !important;
            box-shadow: 0 0 15px currentColor !important;
            transform: scale(1.05);
        }
        
        .note-cell.selected {
            outline: 3px solid #00aaff;
            outline-offset: -3px;
        }
        
        .note-cell.paste-preview {
            opacity: 0.6;
            outline: 2px dashed #00ff00;
            outline-offset: -2px;
        }
        
        .bottom-controls {
            background: #242424;
            border-top: 1px solid #2a2a2a;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .status-bar {
            background: #1a1a1a;
            border-top: 1px solid #2a2a2a;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #999;
            flex-shrink: 0;
        }
        
        button.active {
            background: #3a5a3a;
            border-color: #4a7a4a;
        }
        
        button#playBtn.active {
            background: #3a4a5a;
            border-color: #4a6a8a;
        }
        
        button#eraseBtn.active {
            background: #5a3a3a;
            border-color: #7a4a4a;
        }
        
        .left-controls, .right-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .instrument-list {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .inst-chip {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid;
            min-height: 44px;
            display: flex;
            align-items: center;
            touch-action: manipulation;
        }
        
        .inst-chip.selected {
            border-width: 2px;
        }
        
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #242424;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #2a2a2a;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .note-popup {
            position: fixed;
            background: #242424;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            display: none;
            z-index: 900;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            max-width: 90vw;
            max-height: 70vh;
            flex-direction: column;
        }
        
        .note-popup.active {
            display: flex;
        }
        
        .note-popup-header {
            padding: 12px 16px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .note-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            padding: 16px;
            max-height: 60vh;
            overflow-y: auto;
            min-width: 280px;
        }
        
        .note-item {
            padding: 16px;
            text-align: center;
            background: #1a1a1a;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        
        .note-item:hover {
            background: #2a2a2a;
        }
        
        .code-output {
            background: #1a1a1a;
            padding: 16px;
            border-radius: 6px;
            font-size: 12px;
            white-space: pre-wrap;
            font-family: monospace;
            border: 1px solid #2a2a2a;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="top-panel">
        <div>
            <h1>Unique's Tracker for MakeCode</h1>
            <div style="font-size: 11px; color: #999; margin-top: 2px;">v1.2.0</div>
        </div>
        <div class="top-actions">
            <label>Steps</label>
            <input type="number" id="stepCount" value="16" min="1" max="256" style="width:70px">
            <button id="setStepsBtn">Set</button>
            <label>BPM</label>
            <input type="number" id="bpm" value="120" min="60" max="240" style="width:70px">
            <button id="exportBtn">Export</button>
        </div>
    </div>

    <div class="tracker-container">
        <div class="tracker-grid" id="grid"></div>
    </div>

    <div class="bottom-controls">
        <div class="left-controls">
            <button id="playBtn">Play</button>
            <button id="stopBtn">Stop</button>
            <button id="drawBtn">Draw</button>
            <button id="selectBtn">Select</button>
            <button id="eraseBtn">Erase</button>
            <button id="clearBtn">Clear All</button>
            <button id="demoBtn">Demo</button>
        </div>
        <div class="right-controls">
            <label>Instrument</label>
            <div class="instrument-list" id="instList"></div>
            <button id="noteBtn">â™ª</button>
        </div>
    </div>

    <div class="status-bar">
        <div id="statusText">Ready</div>
        <div id="selectionCount"></div>
    </div>

    <div class="note-popup" id="notePopup">
        <div class="note-popup-header">
            <h3>Select Note</h3>
            <button onclick="document.getElementById('notePopup').classList.remove('active')" style="background:none;border:none;color:#e8e8e8;font-size:24px;cursor:pointer;">&times;</button>
        </div>
        <div class="note-grid" id="noteGrid"></div>
    </div>

    <div class="modal" id="exportModal">
        <div class="modal-content" style="max-width:800px">
            <div class="modal-header">
                <h2>Export Code</h2>
                <button onclick="closeModal('exportModal')" style="background:none;border:none;color:#e8e8e8;font-size:24px;cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="code-output" id="code"></div>
            </div>
            <div class="modal-footer">
                <button onclick="copyCode()">Copy Code</button>
                <button onclick="closeModal('exportModal')">Close</button>
            </div>
        </div>
    </div>

    <script>
        const ctx = new AudioContext();
        const CHANNELS = 6;
        let ROWS = 16;
        let beatsPerMeasure = 4;
        
        let pattern = [];
        for (let i = 0; i < ROWS; i++) {
            pattern.push([null, null, null, null, null, null]);
        }
        
        let playing = false, row = 0, timer = null, oscs = [];
        let selInst = 'square', selNote = 'C4';
        let eraseMode = false, selectMode = false, drawMode = true;
        let playingCells = [];
        let selectedCells = new Set();
        
        const notes = {
            'C4':262,'C#4':277,'D4':294,'D#4':311,'E4':330,'F4':349,'F#4':370,'G4':392,'G#4':415,'A4':440,'A#4':466,'B4':494,
            'C5':523,'C#5':554,'D5':587,'D#5':622,'E5':659,'F5':698,'F#5':740,'G5':784,'G#5':831,'A5':880,'A#5':932,'B5':988,
            'C3':131,'C#3':139,'D3':147,'D#3':156,'E3':165,'F3':175,'F#3':185,'G3':196,'G#3':208,'A3':220,'A#3':233,'B3':247
        };
        
        let insts = {
            sine:{name:'Sine',wave:'sine',color:'#1a3a4a',text:'#6ab4d4'},
            square:{name:'Square',wave:'square',color:'#3a2a4a',text:'#b47ad4'},
            sawtooth:{name:'Saw',wave:'sawtooth',color:'#4a3a2a',text:'#d49a6a'},
            triangle:{name:'Tri',wave:'triangle',color:'#2a4a3a',text:'#7ad4a4'},
            noise:{name:'Noise',wave:'noise',color:'#3a3a3a',text:'#aaa'}
        };
        
        function initInsts() {
            const list = document.getElementById('instList');
            list.innerHTML = '';
            Object.keys(insts).forEach(k => {
                const i = insts[k];
                const c = document.createElement('div');
                c.className = 'inst-chip'+(selInst===k?' selected':'');
                c.textContent = i.name;
                c.style.backgroundColor = i.color;
                c.style.borderColor = i.text;
                c.style.color = i.text;
                c.onclick = () => { selInst = k; initInsts(); };
                list.appendChild(c);
            });
        }
        
        function setSteps() {
            const newRows = parseInt(document.getElementById('stepCount').value);
            if (isNaN(newRows) || newRows < 1 || newRows > 256) {
                alert('Steps must be between 1 and 256');
                return;
            }
            const newPattern = [];
            for (let i = 0; i < newRows; i++) {
                newPattern.push([null, null, null, null, null, null]);
            }
            for (let i = 0; i < Math.min(ROWS, newRows); i++) {
                for (let j = 0; j < CHANNELS; j++) {
                    newPattern[i][j] = pattern[i][j];
                }
            }
            pattern = newPattern;
            ROWS = newRows;
            initGrid();
        }
        
        function initGrid() {
            const g = document.getElementById('grid');
            g.innerHTML = '<div class="header-cell">Step</div>';
            for (let i = 1; i <= CHANNELS; i++) {
                g.innerHTML += '<div class="header-cell">CH'+i+'</div>';
            }
            
            for (let r = 0; r < ROWS; r++) {
                const s = document.createElement('div');
                s.className = 'step-number';
                if (r % beatsPerMeasure === 0) s.classList.add('measure-start');
                s.textContent = (r+1).toString().padStart(2,'0');
                g.appendChild(s);
                
                for (let c = 0; c < CHANNELS; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'note-cell';
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    const n = pattern[r][c];
                    if (n) {
                        const i = insts[n.inst] || insts['square'];
                        cell.textContent = n.note+'\n'+i.name;
                        cell.classList.add('active');
                        cell.style.backgroundColor = i.color;
                        cell.style.borderColor = i.text;
                        cell.style.color = i.text;
                    } else {
                        cell.textContent = '---';
                    }
                    cell.onclick = () => handleCellClick(r, c);
                    g.appendChild(cell);
                }
            }
        }
        
        function handleCellClick(r, c) {
            if (eraseMode) {
                pattern[r][c] = null;
            } else if (selNote && selInst) {
                pattern[r][c] = {note:selNote,inst:selInst};
                const i = insts[selInst];
                playNote(notes[selNote], i.wave, 0.3);
            }
            initGrid();
        }
        
        function initNotes() {
            const g = document.getElementById('noteGrid');
            g.innerHTML = '';
            Object.keys(notes).forEach(n => {
                const d = document.createElement('div');
                d.className = 'note-item';
                d.textContent = n;
                d.onclick = () => {
                    selNote = n;
                    const i = insts[selInst];
                    playNote(notes[n], i.wave, 0.3);
                    document.getElementById('notePopup').classList.remove('active');
                };
                g.appendChild(d);
            });
        }
        
        function playNote(freq, wave, dur) {
            const g = ctx.createGain();
            g.connect(ctx.destination);
            g.gain.setValueAtTime(0.3, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+dur);
            
            if (wave === 'noise') {
                const buf = ctx.createBuffer(1, ctx.sampleRate*2, ctx.sampleRate);
                const data = buf.getChannelData(0);
                for (let i = 0; i < data.length; i++) data[i] = Math.random()*2-1;
                const src = ctx.createBufferSource();
                src.buffer = buf;
                src.connect(g);
                src.start();
                src.stop(ctx.currentTime+dur);
                oscs.push(src);
            } else {
                const osc = ctx.createOscillator();
                osc.type = wave;
                osc.frequency.value = freq;
                osc.connect(g);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime+dur);
                oscs.push(osc);
            }
        }
        
        function playRow(r) {
            playingCells.forEach(cell => cell.classList.remove('playing'));
            playingCells = [];
            
            const bpm = parseInt(document.getElementById('bpm').value);
            const stepDur = (60/bpm) * 0.9;
            
            for (let c = 0; c < CHANNELS; c++) {
                const n = pattern[r][c];
                if (n) {
                    const cell = document.querySelector('.note-cell[data-row="'+r+'"][data-col="'+c+'"]');
                    if (cell) {
                        cell.classList.add('playing');
                        playingCells.push(cell);
                    }
                    const i = insts[n.inst] || insts['square'];
                    playNote(notes[n.note], i.wave, stepDur);
                }
            }
        }
        
        function play() {
            if (playing) return;
            playing = true;
            row = 0;
            const bpm = parseInt(document.getElementById('bpm').value);
            const msPerStep = (60/bpm)*1000;
            playRow(row);
            document.getElementById('playBtn').classList.add('active');
            timer = setInterval(() => {
                row = (row+1)%ROWS;
                playRow(row);
            }, msPerStep);
        }
        
        function stop() {
            playing = false;
            clearInterval(timer);
            oscs.forEach(o => { try { o.stop(); } catch(e){} });
            oscs = [];
            playingCells.forEach(cell => cell.classList.remove('playing'));
            playingCells = [];
            document.getElementById('playBtn').classList.remove('active');
        }
        
        function demo() {
            ROWS = 8;
            document.getElementById('stepCount').value = 8;
            document.getElementById('bpm').value = 150;
            pattern = [];
            for (let i = 0; i < ROWS; i++) {
                pattern.push([null, null, null, null, null, null]);
            }
            pattern[0][0] = {note:'C4',inst:'square'};
            pattern[1][0] = {note:'E4',inst:'square'};
            pattern[2][0] = {note:'G4',inst:'square'};
            pattern[3][0] = {note:'C5',inst:'square'};
            pattern[4][0] = {note:'C4',inst:'sine'};
            pattern[5][0] = {note:'E4',inst:'sine'};
            pattern[6][0] = {note:'G4',inst:'sine'};
            pattern[7][0] = {note:'C5',inst:'sine'};
            initGrid();
        }
        
        function exportCode() {
            alert('Export feature - code would be generated here!');
            openModal('exportModal');
        }
        
        function copyCode() {
            alert('Code copied to clipboard!');
        }
        
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        document.getElementById('noteBtn').onclick = () => {
            document.getElementById('notePopup').classList.toggle('active');
        };
        
        document.getElementById('playBtn').onclick = play;
        document.getElementById('stopBtn').onclick = stop;
        document.getElementById('drawBtn').onclick = () => {
            drawMode = true;
            selectMode = false;
            eraseMode = false;
            document.getElementById('drawBtn').classList.add('active');
            document.getElementById('selectBtn').classList.remove('active');
            document.getElementById('eraseBtn').classList.remove('active');
        };
        document.getElementById('selectBtn').onclick = () => {
            selectMode = !selectMode;
            drawMode = false;
            eraseMode = false;
            document.getElementById('selectBtn').classList.toggle('active');
            document.getElementById('drawBtn').classList.remove('active');
            document.getElementById('eraseBtn').classList.remove('active');
        };
        document.getElementById('eraseBtn').onclick = () => {
            eraseMode = !eraseMode;
            drawMode = false;
            selectMode = false;
            document.getElementById('eraseBtn').classList.toggle('active');
            document.getElementById('drawBtn').classList.remove('active');
            document.getElementById('selectBtn').classList.remove('active');
        };
        document.getElementById('clearBtn').onclick = () => {
            if (confirm('Clear all notes?')) {
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < CHANNELS; c++) {
                        pattern[r][c] = null;
                    }
                }
                initGrid();
            }
        };
        document.getElementById('demoBtn').onclick = demo;
        document.getElementById('setStepsBtn').onclick = setSteps;
        document.getElementById('exportBtn').onclick = exportCode;
        
        initInsts();
        initGrid();
        initNotes();
        document.getElementById('drawBtn').classList.add('active');
    </script>
</body>
</html>
